<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backup Fácil ACS - Sua Empresa</title>
  <style>
    body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;text-align:center;padding:40px}
    .box{background:rgba(255,255,255,0.95);color:#222;border-radius:20px;padding:40px;max-width:800px;margin:auto;box-shadow:0 15px 35px rgba(0,0,0,0.3)}
    h1{color:#1e3c72;margin:0}
    button{background:#e63946;color:white;font-size:20px;padding:16px 40px;border:none;border-radius:50px;cursor:pointer;margin:15px}
    button:hover{background:#d62828}
    button:disabled{background:#999;cursor:not-allowed}
    pre{background:#1e1e1e;color:#0f0;padding:20px;border-radius:12px;margin:25px 0;height:500px;overflow:auto;text-align:left;font-family:Consolas,monospace;font-size:14px}
    .small{font-size:14px;color:#666;margin-top:30px}
  </style>
</head>
<body>
<div class="box">
  <h1>Backup Fácil ACS</h1>
  <p style="color:#1e3c72;font-size:18px">Backup automático direto no Google Drive</p>
  
  <button id="btnAuth">1. Conectar com Google Drive</button>
  <button id="btnBackup" style="display:none">2. Iniciar Backup Completo</button>
  
  <pre id="log">Status: Aguardando conexão com Google Drive...</pre>
  
  <div class="small">
    Versão web 2025 • Não precisa instalar nada • Funciona em qualquer posto
  </div>
</div>

<script type="module">
  const CLIENT_ID = "192507464500-90fk2j4ssuda51ss64vv8ctrhhph75ua.apps.googleusercontent.com";
  const SCOPES = "https://www.www.googleapis.com/auth/drive.file";
  let token = null;

  const pastasParaBackup = [
    "ACS_Sinapse (C:\\ACS_Sinapse\\Servidor\\Util)",
    "ACS_Sintese (C:\\ACS\\Sintese)",
    "ACS_NFe (C:\\ACS_NFe)",
    "ACS_MDFe (C:\\ACS_MDFe)",
    "ACS_CTe (C:\\ACS_CTe)",
    "ACS_Backup1 (C:\\ACS_Backup1)"
  ];

  document.getElementById("btnAuth").onclick = () => {
    google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (resp) => {
        if (resp.error) return log("Erro na autenticação: " + resp.error);
        token = resp.access_token;
        document.getElementById("btnAuth").style.display = "none";
        document.getElementById("btnBackup").style.display = "inline-block";
        log("Conectado com sucesso!\nClique em 'Iniciar Backup Completo' e selecione as pastas na ordem abaixo:\n\n" + pastasParaBackup.map((p,i)=>`${i+1}. ${p}`).join("\n") + "\n\nPronto para começar!");
      }
    }).requestAccessToken();
  };

  document.getElementById("btnBackup").onclick = async () => {
    if (!token) return;
    document.getElementById("btnBackup").disabled = true;
    log("\nIniciando backup completo...\n");

    for (let i = 0; i < 6; i++) {
      log(`\n(${i+1}/6) Selecione a pasta: ${pastasParaBackup[i]}\n`);
      try {
        const dirHandle = await window.showDirectoryPicker();
        const pastaNome = pastasParaBackup[i].split(" ")[0];
        await uploadDirectory(dirHandle, pastaNome);
        log(`Backup da pasta ${pastaNome} concluído!\n`);
      } catch (e) {
        log(`Erro ou cancelado na pasta ${i+1}: ${e.message || "Cancelado pelo usuário"}\n`);
      }
    }

    log("\nBACKUP COMPLETO FINALIZADO COM SUCESSO!\nTodos os arquivos estão no seu Google Drive → 'Backups ACS'");
    document.getElementById("btnBackup").disabled = false;
  };

  async function uploadDirectory(dirHandle, pastaRaiz) {
    const hoje = new Date().toISOString().slice(0,10);
    let folderId = null;

    // Cria pasta do dia
    const resp = await fetch("https://www.googleapis.com/drive/v3/files", {
      method: "POST",
      headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
      body: JSON.stringify({ name: `Backup_ACS_${hoje}_${pastaRaiz}`, mimeType: "application/vnd.google-apps.folder" })
    });
    folderId = (await resp.json()).id;

    for await (const entry of dirHandle.values()) {
      if (entry.kind === "file") {
        const file = await entry.getFile();
        await uploadFile(file, folderId);
      } else if (entry.kind === "directory") {
        await uploadSubdirectory(entry, folderId);
      }
    }
  }

  async function uploadSubdirectory(dirHandle, parentId) {
    const resp = await fetch("https://www.googleapis.com/drive/v3/files", {
      method: "POST",
      headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
      body: JSON.stringify({ name: dirHandle.name, mimeType: "application/vnd.google-apps.folder", parents: [parentId] })
    });
    const folderId = (await resp.json()).id;

    for await (const entry of dirHandle.values()) {
      if (entry.kind === "file") {
        const file = await entry.getFile();
        await uploadFile(file, folderId);
      } else if (entry.kind === "directory") {
        await uploadSubdirectory(entry, folderId);
      }
    }
  }

  async function uploadFile(file, parentId) {
    const metadata = { name: file.name, parents: [parentId] };
    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], {type: "application/json"}));
    form.append("file", file);

    await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
      method: "POST",
      headers: { "Authorization": "Bearer " + token },
      body: form
    });
    log(`↑ ${file.name} (${(file.size/1024/1024).toFixed(1)} MB)`);
  }

  function log(txt) {
    document.getElementById("log").textContent += txt + "\n";
    document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
  }
</script>
<script src="https://accounts.google.com/gsi/client" async></script>
</body>
</html>
